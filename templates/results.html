{% extends "base.html" %}

{% block title %}{{ meeting.title }} - Meeting Results{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Meeting Header -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-1">{{ meeting.title }}</h3>
                    <small class="text-muted">
                        <i class="fas fa-calendar me-1"></i>{{ meeting.date }} | 
                        <i class="fas fa-clock me-1"></i>{{ meeting.created_at[:19] }}
                    </small>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/export/{{ meeting.id }}/pdf">
                            <i class="fas fa-file-pdf text-danger me-2"></i>Download PDF
                        </a></li>
                        <li><a class="dropdown-item" href="/export/{{ meeting.id }}/txt">
                            <i class="fas fa-file-alt text-primary me-2"></i>Download Text
                        </a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                {% if meeting.attendees %}
                <p><strong>Attendees:</strong> {{ meeting.attendees }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Meeting Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt text-primary me-2"></i>
                    Meeting Summary
                </h5>
            </div>
            <div class="card-body">
                <div id="summaryContent">{{ meeting.summary | safe }}</div>
            </div>
        </div>

        <!-- Action Items -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-tasks text-success me-2"></i>
                    Action Items ({{ action_items|length }})
                </h5>
                {% if action_items %}
                <button class="btn btn-outline-primary btn-sm" onclick="syncToCalendar()">
                    <i class="fas fa-calendar-plus me-1"></i>
                    Sync to Calendar
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if action_items %}
                    <div class="row">
                        {% for item in action_items %}
                        <div class="col-md-6 mb-3">
                            <div class="card action-item-card {% if item.priority == 'High' %}border-danger{% elif item.priority == 'Medium' %}border-warning{% else %}border-info{% endif %}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <span class="badge bg-{% if item.priority == 'High' %}danger{% elif item.priority == 'Medium' %}warning{% else %}info{% endif %}">
                                            {{ item.priority }} Priority
                                        </span>
                                        <input type="checkbox" class="form-check-input action-item-checkbox" 
                                               data-item-id="{{ item.id }}" {% if item.completed %}checked{% endif %}>
                                    </div>
                                    <p class="card-text">{{ item.description }}</p>
                                    <div class="small text-muted">
                                        {% if item.assignee and item.assignee != 'Unassigned' %}
                                        <i class="fas fa-user me-1"></i>{{ item.assignee }}<br>
                                        {% endif %}
                                        {% if item.due_date and item.due_date != 'No due date specified' %}
                                        <i class="fas fa-calendar me-1"></i>{{ item.due_date }}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-info-circle fa-2x mb-2"></i>
                        <p>No action items were identified in this meeting.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Full Transcription (Collapsible) -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <button class="btn btn-link p-0 text-decoration-none" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#transcriptionCollapse">
                        <i class="fas fa-microphone text-info me-2"></i>
                        Full Transcription
                        <i class="fas fa-chevron-down float-end mt-1"></i>
                    </button>
                </h5>
            </div>
            <div class="collapse" id="transcriptionCollapse">
                <div class="card-body">
                    <div style="max-height: 400px; overflow-y: auto;">
                        <pre class="text-wrap">{{ meeting.transcription }}</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="text-center">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i class="fas fa-home me-1"></i>Back to Home
            </a>
            <a href="{{ url_for('upload_page') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>Process Another Meeting
            </a>
        </div>
    </div>
</div>

<!-- Calendar Sync Modal -->
<div class="modal fade" id="calendarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sync Action Items to Calendar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Select action items to add to your Google Calendar:</p>
                <div id="calendarItems">
                    {% for item in action_items %}
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="{{ item.id }}" 
                               id="calItem{{ item.id }}" checked>
                        <label class="form-check-label" for="calItem{{ item.id }}">
                            {{ item.description[:80] }}{% if item.description|length > 80 %}...{% endif %}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="performCalendarSync()">
                    <i class="fas fa-calendar-plus me-1"></i>Add to Calendar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toggle action item completion
document.querySelectorAll('.action-item-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const itemId = this.dataset.itemId;
        const completed = this.checked;

        // Here you would typically send an AJAX request to update the database
        console.log(`Action item ${itemId} marked as ${completed ? 'completed' : 'incomplete'}`);
    });
});

function syncToCalendar() {
    const modal = new bootstrap.Modal(document.getElementById('calendarModal'));
    modal.show();
}

async function performCalendarSync() {
    const selectedItems = [];
    document.querySelectorAll('#calendarItems input[type="checkbox"]:checked').forEach(cb => {
        selectedItems.push(parseInt(cb.value));
    });

    if (selectedItems.length === 0) {
        alert('Please select at least one action item to sync.');
        return;
    }

    try {
        const response = await fetch('/calendar_integration', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                meeting_id: {{ meeting.id }},
                action_items: selectedItems
            })
        });

        const result = await response.json();

        if (result.success) {
            alert(`Successfully added ${selectedItems.length} action items to your calendar!`);
            bootstrap.Modal.getInstance(document.getElementById('calendarModal')).hide();
        } else {
            alert('Error syncing to calendar: ' + result.error);
        }
    } catch (error) {
        alert('Error syncing to calendar. Please try again.');
        console.error('Calendar sync error:', error);
    }
}
</script>
{% endblock %}