{% extends "base.html" %}

{% block content %}
<div class="hero-section text-center py-5 mb-5">
    <div class="container">
        <h1 class="display-4 mb-4">
            <i class="fas fa-robot text-primary me-3"></i>
            AI Meeting Notes Generator
        </h1>
        <p class="lead text-muted mb-4">
            Transform your audio recordings into comprehensive meeting summaries and actionable items using AI
        </p>
        <div class="row justify-content-center">
            <div class="col-md-8">
                <a href="{{ url_for('upload_page') }}" class="btn btn-primary btn-lg me-3">
                    <i class="fas fa-upload me-2"></i>
                    Upload Audio Recording
                </a>
                <button class="btn btn-outline-secondary btn-lg" onclick="startRecording()">
                    <i class="fas fa-microphone me-2"></i>
                    Record Live Meeting
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-file-audio text-primary display-4 mb-3"></i>
                <h5 class="card-title">Audio Processing</h5>
                <p class="card-text">Upload audio recordings or record meetings directly. Supports multiple formats including MP3, WAV, and M4A.</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-brain text-success display-4 mb-3"></i>
                <h5 class="card-title">AI Summarization</h5>
                <p class="card-text">Powered by Whisper for transcription and Llama 3.1 for intelligent summarization and action item extraction.</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-calendar-plus text-warning display-4 mb-3"></i>
                <h5 class="card-title">Calendar Integration</h5>
                <p class="card-text">Automatically add action items to your Google Calendar with reminders and due dates.</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-5">
    <div class="col-12">
        <h3 class="mb-4">How It Works</h3>
        <div class="row">
            <div class="col-md-3 text-center">
                <div class="process-step">
                    <div class="step-number">1</div>
                    <h6>Upload Audio</h6>
                    <p>Upload your meeting recording or record live</p>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="process-step">
                    <div class="step-number">2</div>
                    <h6>AI Processing</h6>
                    <p>Whisper transcribes, Llama summarizes and extracts actions</p>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="process-step">
                    <div class="step-number">3</div>
                    <h6>Review Results</h6>
                    <p>Edit and review the generated summary and action items</p>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="process-step">
                    <div class="step-number">4</div>
                    <h6>Export & Share</h6>
                    <p>Export to PDF, sync with calendar, or share with team</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Audio Recording Modal -->
<div class="modal fade" id="recordingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Live Meeting Recording</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div id="recordingStatus" class="mb-3">
                        <i class="fas fa-microphone-slash text-muted display-1"></i>
                        <p class="mt-2">Click to start recording</p>
                    </div>
                    <button id="recordBtn" class="btn btn-danger btn-lg" onclick="toggleRecording()">
                        <i class="fas fa-play me-2"></i>Start Recording
                    </button>
                    <div id="recordingTimer" class="mt-3" style="display: none;">
                        <span class="badge bg-danger fs-6">00:00</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="saveRecording" class="btn btn-primary" style="display: none;" onclick="saveRecording()">
                    Save Recording
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let mediaRecorder;
let recordedChunks = [];
let recordingTimer;
let startTime;

function startRecording() {
    document.getElementById('recordingModal').modal = new bootstrap.Modal(document.getElementById('recordingModal'));
    document.getElementById('recordingModal').modal.show();
}

async function toggleRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        stopRecording();
    } else {
        await startRecording();
    }
}

async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];

        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };

        mediaRecorder.start();
        startTime = Date.now();

        // Update UI
        document.getElementById('recordingStatus').innerHTML = `
            <i class="fas fa-microphone text-danger display-1 pulse"></i>
            <p class="mt-2 text-danger">Recording in progress...</p>
        `;
        document.getElementById('recordBtn').innerHTML = '<i class="fas fa-stop me-2"></i>Stop Recording';
        document.getElementById('recordBtn').className = 'btn btn-secondary btn-lg';
        document.getElementById('recordingTimer').style.display = 'block';

        // Start timer
        recordingTimer = setInterval(updateTimer, 1000);

    } catch (error) {
        alert('Error accessing microphone: ' + error.message);
    }
}

function stopRecording() {
    if (mediaRecorder) {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        clearInterval(recordingTimer);

        // Update UI
        document.getElementById('recordingStatus').innerHTML = `
            <i class="fas fa-check-circle text-success display-1"></i>
            <p class="mt-2 text-success">Recording completed!</p>
        `;
        document.getElementById('recordBtn').style.display = 'none';
        document.getElementById('saveRecording').style.display = 'inline-block';
    }
}

function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('recordingTimer').innerHTML = `
        <span class="badge bg-danger fs-6">${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}</span>
    `;
}

function saveRecording() {
    if (recordedChunks.length > 0) {
        const blob = new Blob(recordedChunks, { type: 'audio/wav' });
        const url = URL.createObjectURL(blob);

        // Create download link
        const a = document.createElement('a');
        a.href = url;
        a.download = 'meeting-recording-' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.wav';
        a.click();

        // Redirect to upload page with instructions
        window.location.href = '{{ url_for("upload_page") }}';
    }
}
</script>
{% endblock %}